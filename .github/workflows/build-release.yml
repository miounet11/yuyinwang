name: 'Recording King - Build & Release'

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.2)'
        required: true
        default: 'v1.0.2'

env:
  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get version
        run: echo "PACKAGE_VERSION=$(node -pe "require('./package.json').version")" >> $GITHUB_ENV

      - name: Create release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${process.env.PACKAGE_VERSION}`,
              name: `Recording King v${process.env.PACKAGE_VERSION} - å½•éŸ³ç‹`,
              body: `## ğŸ¤ Recording King v${process.env.PACKAGE_VERSION}

            ### âœ¨ æ–°ç‰¹æ€§
            - å®æ—¶è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½
            - å¤šLLMæ”¯æŒï¼ˆOpenAIã€Claudeã€DeepSeekç­‰ï¼‰
            - å…¨å±€å¿«æ·é”®å½•éŸ³æ§åˆ¶
            - æ™ºèƒ½AIæç¤ºè¯ç®¡ç†
            - è·¨å¹³å°æ”¯æŒ (macOS & Windows)

            ### ğŸ“¦ ä¸‹è½½è¯´æ˜

            **ğŸš¨ é‡è¦æé†’ï¼šæœ¬åº”ç”¨æš‚æœªè¿›è¡Œæ•°å­—ç­¾åï¼Œè¯·æŒ‰ä»¥ä¸‹æŒ‡å—å®‰è£…**

            #### macOS ç”¨æˆ·
            1. ä¸‹è½½ \`Recording-King-v${process.env.PACKAGE_VERSION}-macOS-Universal.dmg\`
            2. åŒå‡»æ‰“å¼€DMGæ–‡ä»¶
            3. å°†åº”ç”¨æ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
            4. é¦–æ¬¡è¿è¡Œä¼šæç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œè¯·ï¼š
               - å‰å¾€ **ç³»ç»Ÿåå¥½è®¾ç½®** > **å®‰å…¨æ€§ä¸éšç§** > **é€šç”¨**
               - ç‚¹å‡» **ä»è¦æ‰“å¼€** æŒ‰é’®
               - æˆ–å³é”®åº”ç”¨é€‰æ‹© **æ‰“å¼€** ä¸¤æ¬¡

            #### Windows ç”¨æˆ·
            1. ä¸‹è½½ \`Recording-King-v${process.env.PACKAGE_VERSION}-Windows-Setup.exe\`
            2. è¿è¡Œå®‰è£…ç¨‹åº
            3. å¦‚é‡åˆ°Windows Defenderæç¤ºï¼š
               - ç‚¹å‡» **æ›´å¤šä¿¡æ¯**
               - é€‰æ‹© **ä»è¦è¿è¡Œ**
            4. æŒ‰æç¤ºå®Œæˆå®‰è£…

            ### ğŸ›¡ï¸ å®‰å…¨è¯´æ˜
            - æœ¬åº”ç”¨å®Œå…¨å¼€æºï¼Œä»£ç å¯åœ¨GitHubæŸ¥çœ‹
            - æœªæ¥ç‰ˆæœ¬å°†æä¾›æ•°å­—ç­¾åä»¥ç®€åŒ–å®‰è£…æµç¨‹
            - æ‰€æœ‰æƒé™è¯·æ±‚éƒ½æ˜¯ä¸ºäº†æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œ

            ### ğŸ¯ å¦‚æœä½ è§‰å¾—æˆ‘å¥½ç”¨ï¼Œé‚£ä¹ˆä½ å°±å«æˆ‘-å½•éŸ³ç‹å§ï¼ğŸ‘‘

            ---
            **å®Œæ•´å®‰è£…æ•™ç¨‹**: [æŸ¥çœ‹è¯¦ç»†è¯´æ˜](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/INSTALLATION-GUIDE.md)`,
              draft: false,
              prerelease: false
            })
            return data.id

  build-binaries:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
            target: 'universal-apple-darwin'
            arch: 'Universal'
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            target: 'x86_64-pc-windows-msvc'
            arch: 'x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

  update-release-notes:
    needs: [create-release, build-binaries]
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update release with installation guide
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è¯»å–å®‰è£…æŒ‡å—
            let installGuide = '';
            try {
              installGuide = fs.readFileSync('./INSTALLATION-GUIDE.md', 'utf8');
            } catch (error) {
              console.log('Installation guide not found, using default');
              installGuide = `
            ## ğŸ“± å®‰è£…æŒ‡å—

            ### macOS å®‰è£…æ­¥éª¤
            1. ä¸‹è½½å¯¹åº”çš„ DMG æ–‡ä»¶
            2. åŒå‡»æ‰“å¼€ï¼Œæ‹–æ‹½åˆ°Applications
            3. é¦–æ¬¡è¿è¡Œéœ€è¦åœ¨å®‰å…¨è®¾ç½®ä¸­å…è®¸

            ### Windows å®‰è£…æ­¥éª¤  
            1. ä¸‹è½½ Setup.exe æ–‡ä»¶
            2. è¿è¡Œå®‰è£…ç¨‹åº
            3. å¦‚æœ‰å®‰å…¨æç¤ºï¼Œé€‰æ‹©"ä»è¦è¿è¡Œ"

            è¯¦ç»†æ•™ç¨‹è¯·æŸ¥çœ‹é¡¹ç›®README.md
            `;
            }

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              body: `## ğŸ¤ Recording King - ä¸“ä¸šè¯­éŸ³è½¬æ–‡å­—åº”ç”¨

            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - ğŸ¯ å®æ—¶è¯­éŸ³è½¬æ–‡å­—ï¼Œå‡†ç¡®ç‡é«˜è¾¾95%+
            - ğŸ¤– é›†æˆ8å¤§AIæ¨¡å‹ï¼šOpenAIã€Claudeã€DeepSeekç­‰
            - âŒ¨ï¸ å…¨å±€å¿«æ·é”®ï¼Œéšæ—¶å¼€å§‹å½•éŸ³
            - ğŸ’¡ æ™ºèƒ½AIæç¤ºè¯ç®¡ç†ç³»ç»Ÿ
            - ğŸŒ å®Œç¾æ”¯æŒä¸­è‹±æ–‡æ··åˆè¯†åˆ«
            - ğŸ“± è·¨å¹³å°æ”¯æŒï¼šmacOS & Windows

            ### ğŸš¨ é‡è¦å®‰è£…è¯´æ˜

            **ç”±äºåº”ç”¨æš‚æœªè¿›è¡Œæ•°å­—ç­¾åï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å®‰è£…ï¼š**

            #### ğŸ macOS ç”¨æˆ·
            1. ä¸‹è½½ \`.dmg\` æ–‡ä»¶å¹¶åŒå‡»æ‰“å¼€
            2. å°† Recording King æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹  
            3. é¦–æ¬¡è¿è¡Œæ—¶ç³»ç»Ÿä¼šæç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼š
               - æ–¹æ³•1ï¼šå‰å¾€ **ç³»ç»Ÿåå¥½è®¾ç½®** > **å®‰å…¨æ€§ä¸éšç§** > **é€šç”¨** > ç‚¹å‡»**ä»è¦æ‰“å¼€**
               - æ–¹æ³•2ï¼šå³é”®ç‚¹å‡»åº”ç”¨ï¼Œé€‰æ‹©**æ‰“å¼€**ï¼Œå†æ¬¡ç¡®è®¤**æ‰“å¼€**

            #### ğŸªŸ Windows ç”¨æˆ·
            1. ä¸‹è½½ \`.exe\` å®‰è£…ç¨‹åº
            2. åŒå‡»è¿è¡Œï¼Œå¦‚é‡Windows Defenderæç¤ºï¼š
               - ç‚¹å‡» **æ›´å¤šä¿¡æ¯**
               - é€‰æ‹© **ä»è¦è¿è¡Œ**
            3. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…

            ### ğŸ›¡ï¸ å®‰å…¨ä¿éšœ
            - âœ… å®Œå…¨å¼€æºï¼Œä»£ç é€æ˜å¯å®¡æŸ¥
            - âœ… æœ¬åœ°å¤„ç†ï¼Œä¸ä¸Šä¼ æ•æ„Ÿæ•°æ®  
            - âœ… æƒé™æœ€å°åŒ–ï¼Œä»…ç”³è¯·å¿…è¦æƒé™
            - ğŸ”„ æœªæ¥ç‰ˆæœ¬å°†æä¾›ä»£ç ç­¾å

            ### ğŸ¯ å¦‚æœä½ è§‰å¾—æˆ‘å¥½ç”¨ï¼Œé‚£ä¹ˆä½ å°±å«æˆ‘-å½•éŸ³ç‹å§ï¼ğŸ‘‘

            ${installGuide}

            ---
            **é¡¹ç›®åœ°å€**: https://github.com/${context.repo.owner}/${context.repo.repo}
            **é—®é¢˜åé¦ˆ**: [æäº¤Issue](https://github.com/${context.repo.owner}/${context.repo.repo}/issues)`
            });

  # æ„å»ºå®Œæˆåçš„é€šçŸ¥
  notify-completion:
    needs: [create-release, build-binaries, update-release-notes]
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: Build Success Notification
        if: needs.build-binaries.result == 'success'
        run: |
          echo "ğŸ‰ Recording King æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ Release: https://github.com/${{ github.repository }}/releases/tag/v$(node -pe "require('./package.json').version")"
          
      - name: Build Failure Notification  
        if: needs.build-binaries.result == 'failure'
        run: |
          echo "âŒ Recording King æ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"