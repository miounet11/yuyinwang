name: 'Manual Release - Recording King'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.2)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
        default: |
          ## âœ¨ æ–°ç‰ˆæœ¬å‘å¸ƒ

          ### ä¸»è¦æ›´æ–°
          - ğŸ¯ æ€§èƒ½ä¼˜åŒ–å’Œç¨³å®šæ€§æå‡
          - ğŸ› ä¿®å¤å·²çŸ¥é—®é¢˜
          - ğŸ”§ ç”¨æˆ·ä½“éªŒæ”¹è¿›

          ### ğŸ“¦ å®‰è£…è¯´æ˜
          ç”±äºæš‚æœªè¿›è¡Œæ•°å­—ç­¾åï¼Œè¯·å‚è€ƒå®‰è£…æŒ‡å—ï¼š
          - [macOS å®‰è£…æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/INSTALLATION-GUIDE.md#-macos-å®‰è£…æŒ‡å—)
          - [Windows å®‰è£…æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/INSTALLATION-GUIDE.md#-windows-å®‰è£…æŒ‡å—)

jobs:
  manual-release:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Update package.json version
        run: |
          # æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION=${{ github.event.inputs.version }}
          VERSION=${VERSION#v}
          
          # æ›´æ–° package.json
          npm version $VERSION --no-git-tag-version
          
          # æ›´æ–° Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          
          echo "CLEAN_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Commit version updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json src-tauri/Cargo.toml
          git commit -m "chore: bump version to ${{ github.event.inputs.version }}"
          git tag ${{ github.event.inputs.version }}
          git push origin main
          git push origin ${{ github.event.inputs.version }}

      - name: Create GitHub Release
        id: create_release
        uses: actions/github-script@v7
        with:
          script: |
            const releaseNotes = `${{ github.event.inputs.release_notes }}` || `
            ## ğŸ¤ Recording King ${{ github.event.inputs.version }} - å½•éŸ³ç‹

            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - ğŸ¯ å®æ—¶è¯­éŸ³è½¬æ–‡å­—ï¼Œå‡†ç¡®ç‡é«˜è¾¾95%+
            - ğŸ¤– é›†æˆ8å¤§AIæ¨¡å‹ï¼šOpenAIã€Claudeã€DeepSeekç­‰
            - âŒ¨ï¸ å…¨å±€å¿«æ·é”®ï¼Œéšæ—¶å¼€å§‹å½•éŸ³
            - ğŸ’¡ æ™ºèƒ½AIæç¤ºè¯ç®¡ç†ç³»ç»Ÿ
            - ğŸŒ å®Œç¾æ”¯æŒä¸­è‹±æ–‡æ··åˆè¯†åˆ«
            - ğŸ“± è·¨å¹³å°æ”¯æŒï¼šmacOS & Windows

            ### ğŸ“¦ ä¸‹è½½å®‰è£…

            **ğŸš¨ é‡è¦ï¼šæœ¬åº”ç”¨æš‚æœªæ•°å­—ç­¾åï¼Œè¯·æŒ‰æŒ‡å—å®‰è£…**

            #### ğŸ macOS ç”¨æˆ·
            1. ä¸‹è½½ \`.dmg\` æ–‡ä»¶
            2. å³é”®é€‰æ‹©"æ‰“å¼€"ï¼ˆä¸è¦åŒå‡»ï¼‰
            3. ç³»ç»Ÿæç¤ºæ—¶é€‰æ‹©"ä»è¦æ‰“å¼€"

            #### ğŸªŸ Windows ç”¨æˆ·  
            1. ä¸‹è½½ \`.exe\` æ–‡ä»¶
            2. Windows Defender æç¤ºæ—¶é€‰æ‹©"æ›´å¤šä¿¡æ¯" > "ä»è¦è¿è¡Œ"

            ğŸ“– **è¯¦ç»†å®‰è£…æ•™ç¨‹**: [æŸ¥çœ‹å®Œæ•´æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/INSTALLATION-GUIDE.md)

            ### ğŸ¯ å¦‚æœä½ è§‰å¾—æˆ‘å¥½ç”¨ï¼Œé‚£ä¹ˆä½ å°±å«æˆ‘-å½•éŸ³ç‹å§ï¼ğŸ‘‘
            `;

            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ github.event.inputs.version }}',
              name: 'Recording King ${{ github.event.inputs.version }} - å½•éŸ³ç‹',
              body: releaseNotes,
              draft: false,
              prerelease: false
            });

            return data.id;

      - name: Trigger Build Workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-release.yml',
              ref: '${{ github.event.inputs.version }}',
              inputs: {
                version: '${{ github.event.inputs.version }}'
              }
            });

      - name: Output Release Info
        run: |
          echo "ğŸ‰ Release created successfully!"
          echo "ğŸ“¦ Version: ${{ github.event.inputs.version }}"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }}"
          echo "â³ Build workflow triggered, binaries will be available soon."