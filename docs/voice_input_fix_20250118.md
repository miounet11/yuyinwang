# 语音输入文本注入修复方案 - 2025年1月18日

## 问题描述
用户报告：使用快捷键进行语音输入后，对话框消失但转换的内容没有注入到输入框，而是出现在"测试转录"区域。

## 根本原因
1. **窗口焦点管理问题**：浮动窗口在显示时会抢夺焦点，导致原始应用失去焦点
2. **文本注入时机不当**：在窗口隐藏后立即注入文本，但原始应用可能还没有完全获得焦点
3. **延迟时间不足**：虽然代码中有延迟，但时间不够充分让系统完成焦点切换

## 修复方案

### 1. 优化的焦点管理流程
修改了 `src/components/QuickVoiceInput.tsx` 中的 `stopRecording` 函数：

```javascript
// 修复后的文本注入流程
1. 先隐藏窗口
2. 等待300ms确保窗口完全隐藏
3. 激活原始应用（如果有bundle_id）
4. 等待500ms确保应用完全获得焦点
5. 注入文本
6. 延迟300ms后关闭窗口
```

### 2. 增强的错误处理
- 添加了详细的控制台日志，便于调试
- 如果文本注入失败，自动复制到剪贴板作为备用方案
- 失败时重新显示窗口，让用户看到转录结果

### 3. 关键改进点
- **增加延迟时间**：从100ms增加到300-500ms
- **更详细的日志**：每个步骤都有日志输出
- **备用方案**：注入失败时自动复制到剪贴板
- **保持窗口状态**：失败时不关闭窗口，让用户可以手动复制

## 测试步骤

### 准备工作
1. 确保应用已编译成功（已完成）
2. 重启 Recording King 应用
3. 打开一个文本编辑器（如 TextEdit、VS Code 或任何输入框）

### 测试流程

#### 测试1：基本功能测试
1. 在文本编辑器中点击，确保光标在输入位置
2. 按住语音输入快捷键
3. 说话录音
4. 松开快捷键
5. **预期结果**：
   - 浮动窗口消失
   - 文本自动注入到编辑器中
   - 不应该出现在"测试转录"区域

#### 测试2：不同应用测试
测试以下应用：
- [ ] TextEdit
- [ ] VS Code
- [ ] Safari 网页输入框
- [ ] Notes 应用
- [ ] Terminal
- [ ] 微信/QQ 输入框

#### 测试3：快速切换测试
1. 快速连续使用语音输入
2. 在不同应用间切换使用
3. 验证每次都能正确注入

### 调试信息收集

打开浏览器控制台（在 Recording King 应用中按 Cmd+Option+I），查看以下日志：

```
准备注入文本，原始应用: {name: "...", bundle_id: "..."}
窗口已隐藏
尝试激活原始应用: com.xxx.xxx
原始应用已激活
开始注入文本: [转录的文本]
✅ 文本注入成功
```

如果看到错误：
```
❌ 文本注入失败: [错误信息]
文本已复制到剪贴板，请手动粘贴
```

### 故障排除

#### 问题1：文本仍然没有注入
**解决方案**：
1. 检查系统偏好设置 > 安全性与隐私 > 辅助功能
2. 确保 Recording King 有权限
3. 重启应用后再试

#### 问题2：注入到错误的位置
**解决方案**：
1. 增加延迟时间（可能需要修改代码）
2. 确保目标应用支持粘贴操作
3. 尝试使用不同的应用测试

#### 问题3：部分应用不工作
**某些应用可能有特殊的输入处理**：
- Terminal 可能需要特殊处理
- 某些 Electron 应用可能不兼容
- 游戏或全屏应用可能无法工作

### 性能优化建议

如果延迟感觉太长，可以尝试调整以下参数：
- 窗口隐藏后的延迟：300ms → 200ms
- 激活应用后的延迟：500ms → 300ms
- 关闭窗口前的延迟：300ms → 100ms

但请注意，减少延迟可能会导致某些情况下注入失败。

## 已知限制

1. **macOS 权限要求**：必须授予辅助功能权限
2. **应用兼容性**：某些应用可能不支持自动粘贴
3. **系统负载**：系统繁忙时可能需要更长的延迟
4. **安全软件**：某些安全软件可能阻止键盘模拟

## 反馈收集

请测试后提供以下信息：
1. 测试的应用名称和版本
2. 是否成功注入
3. 控制台日志（特别是错误信息）
4. 系统版本（macOS 版本）
5. 任何异常行为的描述

## 版本信息
- 修复日期：2025年1月18日
- Recording King 版本：4.6.8
- 修复文件：
  - src/components/QuickVoiceInput.tsx
  - src-tauri/src/commands/voice_input.rs
