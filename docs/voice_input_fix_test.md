# 语音输入修复测试指南

## 问题描述
之前使用快捷键进行语音输入时，转录完成后文本没有正确注入到原始应用的输入框，而是出现在"测试转录"区域。

## 修复内容

### 1. 前端改进 (QuickVoiceInput.tsx)
- ✅ 在显示悬浮窗口前保存原始活动应用信息
- ✅ 转录完成后先隐藏窗口，让原始应用重新获得焦点
- ✅ 添加了激活原始应用的功能（通过 bundle_id）
- ✅ 改进了错误处理和用户反馈

### 2. 后端改进 (voice_input.rs)
- ✅ 添加了 `activate_app_by_bundle_id` 命令，用于激活原始应用
- ✅ 改进了 `inject_text_to_active_app` 命令，使用剪贴板方式更可靠地注入文本
- ✅ 添加了安全检查，防止向 Recording King 自身注入文本

## 测试步骤

### 准备工作
1. 打开新编译的 Recording King 应用
2. 确保已配置好语音输入快捷键（默认：Cmd+Shift+Y）
3. 打开一个文本编辑器（如 TextEdit、VS Code 等）

### 测试流程

#### 测试 1：基本功能测试
1. 在文本编辑器中点击，确保光标在输入位置
2. 按下语音输入快捷键（Cmd+Shift+Y）
3. 看到悬浮录音窗口出现
4. 说话进行录音
5. 松开快捷键停止录音
6. 等待转录完成

**预期结果**：
- 转录的文本应该自动出现在文本编辑器的光标位置
- 悬浮窗口应该自动关闭

#### 测试 2：不同应用测试
测试以下应用：
- [ ] TextEdit
- [ ] VS Code
- [ ] Safari（网页输入框）
- [ ] Notes
- [ ] Terminal

#### 测试 3：错误处理测试
1. 在没有输入焦点的情况下使用快捷键
2. 在 Recording King 自己的输入框中使用快捷键

**预期结果**：
- 应该有适当的错误提示
- 不会导致应用崩溃

## 调试信息

如果仍有问题，请检查：

1. **控制台日志**
   打开终端，运行应用时查看输出：
   ```bash
   /Applications/Recording\ King.app/Contents/MacOS/Recording\ King
   ```

2. **关键日志信息**
   - "保存原始应用: [应用名]" - 确认正确识别了原始应用
   - "已激活应用: [bundle_id]" - 确认成功激活原始应用
   - "文本已插入到原始应用" - 确认文本注入成功

3. **权限检查**
   确保 Recording King 有以下权限：
   - 辅助功能权限（系统偏好设置 > 安全性与隐私 > 隐私 > 辅助功能）
   - 麦克风权限

## 已知限制

1. 某些应用可能有特殊的输入处理机制，可能需要额外适配
2. 如果原始应用被关闭或最小化，文本注入可能失败
3. 某些安全软件可能会阻止文本注入功能

## 反馈

如果测试中发现问题，请记录：
1. 使用的应用名称和版本
2. 具体的操作步骤
3. 实际结果 vs 预期结果
4. 控制台中的错误信息（如果有）

---

修复版本：4.6.8
修复日期：2024-01-18
